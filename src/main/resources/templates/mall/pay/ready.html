<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!------------------------------------------------------------------------------------------------------------------------------>
	<!--스크립트 태그-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>                    <!--jQuery-->
	<script src="https://kit.fontawesome.com/a606a1a405.js" crossorigin="anonymous"></script>                   <!--FontAwesome-->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>        <!--BootStrap-->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js"></script>         <!--SweetAlert2-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>               <!--Toastr-->
	<!--CSS 링크-->
	<link rel="stylesheet" href="/css/main.css">                                                                <!--MainCSS-->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">    <!--FontAwesome-->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">      <!--BootStrap-->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css">     <!--SweetAlert2-->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">       <!--Toastr-->
	<!--기타 삽입-->

	<!------------------------------------------------------------------------------------------------------------------------------>
	<title>Kakao Pay</title>
	<style>
		span { text-align: center; margin: 0 auto}
		div {text-align: center; margin: 0 auto}
		th {text-align: center}
	</style>
	<script>
		let productName = undefined;
		let cartDetailCount = undefined;
		let cartTotalPrice = undefined;
		let taxFreeAmount = undefined;
		$(document).ready(function(){
			$('#kaobtn').click(function() {
				productName = '';
				cartDetailCount = 0;
				if(data.items.length==1){
					productName = data.items[0].productName;
					cartDetailCount = data.items[0].cartDetailCount;
					cartTotalPrice = data.cartTotalPrice;
					taxFreeAmount = Math.round(cartTotalPrice/10);
				}else{
					let i=0;
					for (const item of data.items) {
						cartDetailCount += data.items[i].cartDetailCount;
						i++;
					}
					cartTotalPrice = data.cartTotalPrice;
					taxFreeAmount = Math.round(cartTotalPrice/10);
					productName = data.items[0].productName+ ' 외 '+((data.items.length)-1)+'건';
				}
				$.ajax({
					type:'get',
					url:'/pay/start',
					data: {
						item_name : productName,
						quantity : cartDetailCount,
						total_amount : cartTotalPrice,
						tax_free_amount : taxFreeAmount
					},
					success:function(res) {
						location.href = res.next_redirect_pc_url;
					}
				})
			})

		})
	</script>
</head>
<body>
<script th:inline="javascript">
	const data = [[${map}]];
</script>
	<header th:replace="~{/fragment/header.html}">
	</header>
	<nav th:replace="~{/fragment/nav.html}">
	</nav>
	<main>
		<aside th:replace="~{/fragment/aside.html}">
		</aside>
		<section>
			<h1>주문</h1>
			<h2>결제하실 상품</h2>
	<table style="width:100%;" id="cart_table" class="table table-hover">
		<tr>
			<th></th>
			<th><span>상품 정보</span></th>
			<th><span>금액</span></th>
		</tr>
		<tr th:each="item:${map.items}">
			<td style="width:20%;">
				<img th:src="${item.productImage}" width="100px;" >
			</td>
			<td style="width:30%;">
				<div class="upper">
					<span th:text="${item.productName}"></span>
				</div>
				<div class="lower">
					<span th:text="${item.cartDetailCount}"></span>개
				</div>
			</td>
			<td style="width:20%; text-align: center;">
				<span th:text="${item.cartDetailCount*item.cartDetailPrice}" class="item_price"></span>원
			</td>
		</tr>
	</table>
	<div style="text-align: center">
		결제 총 금액: <span th:text="${map.cartTotalPrice}"></span>원<br>
		<button id="kaobtn">카카오페이</button>
	</div>
		</section>
	</main>
	<footer th:replace="~{/fragment/footer.html}">
	</footer>
</body>
</html>