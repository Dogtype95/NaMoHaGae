<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!------------------------------------------------------------------------------------------------------------------------------>
    <!--스크립트 태그-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>                    <!--jQuery-->
    <script src="https://kit.fontawesome.com/a606a1a405.js" crossorigin="anonymous"></script>                   <!--FontAwesome-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>        <!--BootStrap-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js"></script>         <!--SweetAlert2-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>               <!--Toastr-->
    <!--CSS 링크-->
    <link rel="stylesheet" href="/css/main.css">                                                                <!--MainCSS-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">    <!--FontAwesome-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">      <!--BootStrap-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css">     <!--SweetAlert2-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">       <!--Toastr-->
    <!--기타 삽입-->

    <!------------------------------------------------------------------------------------------------------------------------------>
    <title>장바구니</title>
</head>
<style>
    td {
        vertical-align: middle;
    }

    #sold_out_container {
        position: relative;
        display: inline-block;
    }

    #sold_out_image {
        filter: grayscale(100%);
    }

    #sold_out_text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        font-size: 15px;
        font-weight: bold;
        color: white;
    }
</style>
<script>

    const totalPrice = function (){
        let sum =0;
        $('.item_price').each(function(){
            console.log($(this).text());
            sum += parseInt($(this).text());
        })
        $('#total_price').text(sum);
    }


    $(document).ready(async function() {

        try {
            const result = await $.ajax("/mall/cart/list");
        } catch(err) {
            console.log(err);
        }

        // 장바구니 개수 증가
        $('.lower').on('click', '.plus', async function(){
            const productNo = $(this).attr("data-productNo");
            try{
                const result = await $.ajax({url: "/api/v1/cart/increase?productNo=" + productNo, method: 'patch' });
                $(this).siblings('.count').text(result.cartDetailCount);
                $(this).parent().parent().next().find('.item_price').text((result.cartDetailPrice)*(result.cartDetailCount));
                totalPrice();
            }catch (err){
                alert(err.responseText);
            }
        });


        // 장바구니 개수 감소
        $('.lower').on('click', '.minus', async function(){
            const productNo = $(this).attr("data-productNo");
            try {
                const result = await $.ajax({url: "/api/v1/cart/decrease?productNo=" + productNo, method: 'patch' });
                $(this).siblings('.count').text(result.cartDetailCount);
                $(this).parent().parent().next().find('.item_price').text((result.cartDetailPrice)*(result.cartDetailCount));
                totalPrice();
            } catch(err) {
                alert(err.responseText);
            }
        });


        // 장바구니의 삭제 버튼을 클릭해 해당 장바구니 상품을 삭제
        $('.delete').click(function() {
            const productNo = $(this).attr('data-productNo');
            const $form = $('<form>').attr("action","/cart/remove").attr("method","post").appendTo($('body'));
            $form.append($('<input>').attr('type','hidden').attr('name','list').val(productNo));
            $form.submit();
        });


        // 장바구니에 담긴 상품들을 선택해 삭제하기
        $('#delete').click(function() {
            const checkedProducts = $('.productNo:checked');
            if (checkedProducts.length === 0) {
                alert("삭제할 상품을 선택해주세요");
                return;
            }

            const $form = $('<form>').attr("action","/cart/remove").attr("method","post").appendTo($('body'));
            checkedProducts.each(function(idx, element) {
                const $element = $(element);
                $form.append($('<input>').attr('type','hidden').attr('name','list').val($element.attr('data-productNo')));
            });

            $form.submit();
            $form.remove();
        });


        /*
        // 상품들을 선택해 주문 페이지로 이동
        $('#order').click(function() {
            // 선택한 장바구니 상품이 없으면 처리 중단
            if($('.productNo').prop('checked')==false) {
                alert("구매할 상품을 선택해주세요");
                return;
            }

            const $form = $('<form>').attr("action","/mall/order").attr("method","post").appendTo($('#formArea'));
            $.each($('.productNo'), function(idx, element) {
                if($(this).prop('checked')==true)
                    $form.append($('<input>').attr('type','hidden').attr('name','checkedProductNos').val($(this).attr("data-productNo")));
            });
            $form.submit();
        });
         */


        $('#order').click(function() {
            // 선택한 장바구니 상품이 없으면 처리 중단
            if($('.productNo:checked').length == 0) {
                alert("구매할 상품을 선택해주세요");
                return;
            }

            // 기존에 생성된 폼이 있다면 삭제
            $('#checkedProductNosForm').remove();

            const $form = $('<form>').attr("id", "checkedProductNosForm").attr("action","/mall/order").attr("method","post").appendTo($('#formArea'));
            $.each($('.productNo:checked'), function(idx, element) {
                $form.append($('<input>').attr('type','hidden').attr('name','checkedProductNos').val($(this).attr("data-productNo")));
            });
            $form.submit();
        });


        // 상품 전체 선택
        $('#check_all').click(function() {
            $('.productNo').prop('checked', !$('.productNo').prop('checked'));
        })

        
        $('#kakaoPay').click(function(){
            location.href='/pay';
        })
    });
</script>
<body>
<header th:replace="~{/fragment/header.html}">
</header>
<nav th:replace="~{/fragment/nav.html}">
</nav>
<main>
    <aside th:replace="~{/fragment/aside.html}">
    </aside>
    <section>
        <table style="width:100%;" id="cart_table" class="table table-hover">
            <tr>
                <th>
                    <input type="checkbox" id="check_all">
                </th>
                <th colspan="2">상품 정보</th>
                <th>구매예정금액</th>
                <th>선택</th>
            </tr>
            <tr th:each="item:${map.items}">
                <td style="width:5%;">
                    <input type="checkbox" th:attr="data-productNo=${item.productNo}" class="productNo" th:disabled="${item.productStock == 0}">
                </td>
                <td style="width:10%;">
                    <div th:if="${item.productStock == 0}">
                        <div id="sold_out_container">
                            <img th:src="${item.productImage}" height="75px;" width="75px;" id="sold_out_image">
                            <span id="sold_out_text">품절</span>
                        </div>
                    </div>
                    <div th:unless="${item.productStock == 0}">
                        <img th:src="${item.productImage}" height="75px;" width="75px;">
                    </div>
                </td>
                <td style="width:60%;">
                    <div class="upper">
                        <span th:text="${item.productName}"></span>
                    </div>
                    <div class="lower">
                    <!-- 재고가 0이면 버튼 비활성화 -->
                        <button type="button" class="btn btn-primary minus" th:attr="data-productNo=${item.productNo}" th:disabled="${item.productStock == 0}">-</button>
                        <button type="button" class="btn btn-outline-primary count" th:text="${item.cartDetailCount}" th:disabled="${item.productStock == 0}"></button>
                        <button type="button" class="btn btn-primary plus" th:attr="data-productNo=${item.productNo}" th:disabled="${item.productStock == 0}">+</button>
                    </div>
                </td>
                <td style="width:15%; text-align: center;">
                    <span th:text="${item.cartDetailCount*item.cartDetailPrice}" class="item_price"></span>원
                </td>
                <td style="width:10%; text-align: center;">
                    <button type="button" class="btn btn-primary delete" th:attr="data-productNo=${item.productNo}">삭제</button>
                </td>
            </tr>
        </table>
        <div class="well well-sm">총액:<span id="total_price" th:text="${map.cartTotalPrice}"></span>원</div>
        <div>
            <button id="order" class="btn btn-outline-success">주문하기</button>
            <button id="delete" class="btn btn-outline-danger">선택 상품 삭제</button>
            <button id="kakaoPay" class="btn btn-outline-primary">카카오 페이로 결제하기</button>
        </div>
        <div id="formArea">
        </div>
    </section>
    <aside th:replace="~{/fragment/bside.html}"></aside>
</main>
<footer th:replace="~{/fragment/footer.html}">
</footer>
</body>
</html>