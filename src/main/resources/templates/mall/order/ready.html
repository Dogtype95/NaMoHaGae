<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!------------------------------------------------------------------------------------------------------------------------------>
    <!--스크립트 태그-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>                    <!--jQuery-->
    <script src="https://kit.fontawesome.com/a606a1a405.js" crossorigin="anonymous"></script>                   <!--FontAwesome-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>        <!--BootStrap-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js"></script>         <!--SweetAlert2-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>               <!--Toastr-->
    <!--CSS 링크-->
    <link rel="stylesheet" href="/css/main.css">                                                                <!--MainCSS-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">    <!--FontAwesome-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">      <!--BootStrap-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css">     <!--SweetAlert2-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">       <!--Toastr-->
    <!--기타 삽입-->

    <!------------------------------------------------------------------------------------------------------------------------------>
<title>상품 주문상세 페이지</title>
<style>
    #placeOrder {
        font-weight: bold;
        font-family: 'Gothic', sans-serif;
        text-align: center;
        font-size: 40px;
    }

    .table td img {
        margin-right: 40px;
    }

    .table-container {
        width: 80%;
        margin: 0 auto;
    }

    .address-container {
        width: 60%;
        margin: 0 auto;
    }

    .table {
        width: 100%;
        margin-left: auto; margin-right: auto;
    }

    .table th {
        text-align: center;
    }

    .productInfo {
        text-align: center;
        vertical-align: middle;
    }

    .title {
        font-weight: bold;
        font-family: 'Gothic', sans-serif;
        text-align: center;
        font-size: 28px;
    }

    .orderDetailTable {
        border-collapse: collapse;
        width: 70%;
    }
</style>
<script th:inline="javascript">
    const data = [[${map}]];
</script>
<script>
    let productName = undefined;
    let cartDetailCount = undefined;
    let cartTotalPrice = undefined;
    let taxFreeAmount = undefined;
    $(document).ready(function() {
        console.log(data);
           const orderItems = data.orderItems;
           const orderTotalPrice = data.orderTotalPrice;
            console.log(orderItems);
            console.log(orderTotalPrice);
        $('#kaobtn').click(function() {
            productName = '';
            cartDetailCount = 0;
            if(data.orderItems.length==1){
                productName = data.orderItems[0].productName;
                cartDetailCount = data.orderItems[0].cartDetailCount;
                cartTotalPrice = data.orderTotalPrice;
                taxFreeAmount = Math.round(cartTotalPrice/10);
            }else{
                let i=0;
                for (const item of data.items) {
                    cartDetailCount += data.items[i].cartDetailCount;
                    i++;
                }
                cartTotalPrice = data.orderTotalPrice;
                taxFreeAmount = Math.round(cartTotalPrice/10);
                productName = data.orderItems[0].productName+ ' 외 '+((data.orderItems.length)-1)+'건';
            }
            $.ajax({
                type:'get',
                url:'/pay/start',
                data: {
                    item_name : productName,
                    quantity : cartDetailCount,
                    total_amount : cartTotalPrice,
                    tax_free_amount : taxFreeAmount
                },
                success:function(res) {
                    location.href = res.next_redirect_pc_url;
                }
            })
        })


        $("#order").click(function() {
            const $form = $('<form>').attr('action', "/order/check").attr('method','post');
            $.each($(".addressNo"), function(idx, element) {
                if($(element).attr("checked")=="checked")
                    $('<input type="hidden" name="addressNo">').val($(element).val()).appendTo($form);
            });
            $form.appendTo($('body')).submit();
        })
    })
</script>
</head>
<body>
<header th:replace="~{/fragment/header.html}"></header>
<nav th:replace="~{/fragment/nav.html}"></nav>
<main>
<aside th:replace="~{/fragment/aside.html}"></aside>
<section>
    <div class="table-container">
        <div id="placeOrder">구매하기</div>
        <br>
        <table class="table table-hover">
            <colgroup>
                <col style="width: 50%;">
                <col style="width: 25%;">
                <col style="width: 25%;">
            </colgroup>
            <thead>
                <tr>
                    <th>상품정보</th><th>수량</th><th>상품금액</th>
                </tr>
            </thead>
            <tbody id="orderItems">
                <tr th:each="i:${map.orderItems}">
                    <td class="productInfo" style="padding-top: 20px; padding-bottom: 20px;">
                        <img th:src="${i.productImage}" width="100px" height="100px">
                        <span th:text="${i.productName}"></span>
                    </td>
                    <td class="productInfo"><span th:text="${i.cartDetailCount}" style="font-weight: bold"></span></td>
                    <td class="productInfo"><span th:text="${#numbers.formatInteger(i.cartDetailPrice,0,'COMMA')}"></span>원</td>
                </tr>
                <tr>
                    <td style="font-weight: bold; text-align: left; padding-top: 20px; padding-bottom: 20px;">주문금액</td>
                    <td colspan="2" class="productInfo">
                        <span style="font-weight: bold" th:text="${#numbers.formatInteger(map.orderTotalPrice+3000,0,'COMMA')}+'원'")></span>
                        <span th:text="'(상품가 '+${#numbers.formatInteger(map.orderTotalPrice,0,'COMMA')}+'원+배송비 3,000원)'"></span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <br>
    <br>

    <div>
        <div class="title">배송지정보</div>
        <br>
        <div>
            <div th:each="a:${map.addresses}" class="address-container">
                <div th:class="${a.defaultAddressEnabled==true} ? 'card bg-secondary text-white' : 'card'">
                    <div class="card-body">
                        <input type="radio" class="form-check-input addressNo" th:checked="${a.addressNo}" th:value="${a.addressNo}" name="address">
                        (<span th:text="${a.addressName}"></span>)
                        <span th:text="${a.addressAddress}"></span>
                        <span th:text="${a.addressAddressDetail}"></span>
                    </div>
                </div>
            </div>
            <div class="mb-3 mt-3" style="width: 60%; margin: 0 auto; text-align: right;">
                <a type="button" class="btn btn-secondary" href="http://localhost:8081/member/mall/address/add" style="color: white;">배송지 추가</a>
            </div>
        </div>
        <br>
    </div>

        <div style="text-align: center">
            <div class="title">뼈다귀 포인트 사용</div>
            <br>
                <div>보유</div>
                <div>사용</div>
        </div>
    <br>
    <br>

        <div style="text-align: center">
            <div class="title">결제상세</div>
            <br>
                <div>
                    <span>주문금액</span>
                    <span th:text="${#numbers.formatInteger(map.orderTotalPrice,0,'COMMA')}+'원'"></span>
                </div>
                <div>
                    <span>배송비</span>
                    <span>+3,000원</span>
                </div>
                <div>
                    <span>뼈다귀 포인트 사용</span>
                    <span></span>
                </div>
        </div>
    <br>
    <br>

        <div style="text-align: center">
            <div class="title">결제예정금액</div>
            <br>
            <div th:text="${#numbers.formatInteger(map.orderTotalPrice+3000,0,'COMMA')}+'원'"></div>
        </div>
    <br>
    <br>
    <br>

        <div style="text-align: center">
            <button id="order" type="button" class="btn btn-primary btn-block">결제하기</button>
            <button id="kaobtn" type="button" class="btn btn-primary btn-block">카카오페이</button>
        </div>
</section>
<aside th:replace="~{/fragment/bside.html}"></aside>
</main>
<footer th:replace="~{/fragment/footer.html}">
</footer>
</body>
</html>