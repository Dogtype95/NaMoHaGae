<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!------------------------------------------------------------------------------------------------------------------------------>
    <!--스크립트 태그-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>                    <!--jQuery-->
    <script src="https://kit.fontawesome.com/a606a1a405.js" crossorigin="anonymous"></script>                   <!--FontAwesome-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>        <!--BootStrap-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js"></script>         <!--SweetAlert2-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>               <!--Toastr-->
    <!--CSS 링크-->
    <link rel="stylesheet" href="/css/main.css">                                                                <!--MainCSS-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">    <!--FontAwesome-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">      <!--BootStrap-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css">     <!--SweetAlert2-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">       <!--Toastr-->
    <!--기타 삽입-->

    <!------------------------------------------------------------------------------------------------------------------------------>
<title>상품 상세 보기 페이지</title>
<style>
    #content {
        border: 1px solid #ccc;
    }
    #left {
        float:left;
        width: 50%;
        height:500px;
    }
    #right {
        float: right;
        width: 50%;
        display: flex;
        flex-direction: column;
        height:200px;
    }
    #buttons {
        display: inline-block;
    }
    #content {
        height: 500px;
    }
    .choice_image {
        border: 1px solid black;
    }

    .images:hover {
        cursor: pointer;
    }

    .qna-icon {
        display: inline-block;
        margin-right: 5px;
        width: 20px;
        height: 20px;
        text-align: center;
        line-height: 20px;
        border-radius: 50%;
    }

    .qna-question .qna-icon {
        background-color: #007bff;
        color: #fff;
    }

    .qna-answer .qna-icon {
        background-color: #28a745;
        color: #fff;
    }

    .qna-arrow {
        margin-right: 5px;
        font-size: 14px;
        color: #999;
    }
</style>
<script>
    // 날짜 yyyy-MM-dd
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        const year = date.getFullYear();
        const month = ('0' + (date.getMonth() + 1)).slice(-2);
        const day = ('0' + date.getDate()).slice(-2);
        return `${year}-${month}-${day}`;
    }

    // 리뷰리스트 출력
    function printReview(review) {
        const $tbody = $('#review');
        $tbody.empty();
        for(const r of review) {
            const rating = parseInt(r.productReviewStar);
            const ReviewStarIcon = '★'.repeat(rating) + '☆'.repeat(5 - rating);
            const tpl = `<tr>
        <td>${ReviewStarIcon}</td>
        <td>${r.productReviewContent}</td>
				<td>${r.productReviewWriter}</td>
				<td>${formatDate(r.productReviewWriteDate)}</td>
			</tr>`;
            $tbody.append(tpl);
        }
    }


    function printPagination({prev, start, end, next, pageno}) {
        const $ul = $('#page_ul');
        $ul.empty();
        if (prev > 0) {
            $ul.append(`<li class='page-item'><a class='page-link' href='#' data-page-no='${prev}'>이전</a></li>`);
        }
        for (let i = start; i <= end; i++) {
            const tpl = `<li class='page-item ${i === pageno ? "active" : ""}'><a class='page-link' href='#' data-page-no='${i}'>${i}</a></li>`;
            $ul.append(tpl);
        }
        if (next > 0) {
            $ul.append(`<li class='page-item'><a class='page-link' href='#' data-page-no='${next}'>다음</a></li>`);
        }
    }


    //큐엔에이리스트 출력
    function printQnaBoard(qna) {
        const $tbody = $('#qna');
        $tbody.empty();
        for (const q of qna) {
            let tpl = `
      <tr class="qna-question">
        <td>
          <span class="qna-icon">Q</span>
          ${q.qnaContent}
        </td>
        <td>${q.qnaWriter}</td>
        <td>${formatDate(q.qnaWriteDate)}</td>
      </tr>`;
            if (q.qnaAnswerContent !== null) {
                tpl += `
        <tr class="qna-answer">
          <td>
            <span class="qna-arrow">&rarr;</span>
            <span class="qna-icon">A</span>
            ${q.qnaAnswerContent}
          </td>
          <td>관리자</td>
          <td>${formatDate(q.qnaAnswerWriteDate)}</td>
        </tr>`;
            }
            $tbody.append(tpl);
        }
    }

    function printQnaPagination({prev, start, end, next, pageno}) {
        const $ul = $('#q_page_ul');
        $ul.empty();
        if (prev > 0) {
            $ul.append(`<li class='page-item'><a class='page-link' href='#' data-page-no='${prev}'>이전</a></li>`);
        }
        for (let i = start; i <= end; i++) {
            const tpl = `<li class='page-item ${i === pageno ? "active" : ""}'><a class='page-link' href='#' data-page-no='${i}'>${i}</a></li>`;
            $ul.append(tpl);
        }
        if (next > 0) {
            $ul.append(`<li class='page-item'><a class='page-link' href='#' data-page-no='${next}'>다음</a></li>`);
        }
    }



    $(document).ready(async function() {
        let result = undefined;
        const param = new URLSearchParams(location.search);
        const productNo = param.get('productNo');
        const pageno = param.get('pageno') == null ? 1 : param.get('pageno');

        try {
            result = await $.ajax("/api/v1/mall/product/review?pageNo=" + pageno + "&productNo=" + productNo);
            console.log(result);
            printReview(result.review);
            printPagination({prev: result.prev, start: result.start, end: result.end, next: result.next, pageno: pageno, productNo: productNo});


        } catch (err) {
            console.log(err);
        }

        try {
            result = await $.ajax("/api/v1/mall/product/qna?pageNo=" + pageno + "&productNo=" + productNo);
            printQnaBoard(result.qna);
            printQnaPagination({prev: result.prev, start: result.start, end: result.end, next: result.next, pageno: pageno, productNo: productNo});

            $('#q_page_ul').on('click', '.page-link', async function (e) {
                e.preventDefault();
                const pageNum = $(this).data('page-no');
                try {
                    result = await $.ajax("/api/v1/mall/product/qna?pageNo=" + pageNum + "&productNo=" + productNo);
                    printQnaBoard(result.qna);
                    printQnaPagination(result);
                } catch (err) {
                    console.log(err);
                }
            });
        }catch (err){
            console.log(err);
        }
        $('#page_ul').on('click', '.page-link', async function(e) {
            e.preventDefault();
            const pageNum = $(this).data('page-no');
            try {
                result = await $.ajax("/api/v1/mall/product/review?pageNo=" + pageNum + "&productNo=" + productNo);
                printReview(result.review);
                printPagination(result);
            } catch (err) {
                console.log(err);
            }
        });


        /*
        // 품절시 버튼 변경
        const stock = document.getElementById('productStock').value;

        if (stock == 0) {
            document.getElementById("buy").style.display = "none";
            document.getElementById("cart").style.display = "none";
            document.getElementById("sold_out").style.display = "inline-block";
            document.getElementById("favorite").style.display = "inline-block";
        } else {
            document.getElementById("buy").style.display = "inline-block";
            document.getElementById("cart").style.display = "inline-block";
            document.getElementById("sold_out").style.display = "none";
            document.getElementById("favorite").style.display = "inline-block";
        }
         */


        // 이미지 선택
        $('.images:first-of-type').addClass('choice_image');

        $('.images').click(function() {
            $('.images').removeClass('choice_image');
            $(this).addClass('choice_image');
            $('#select_image').attr('src', $(this).attr('src'));
        });


        // 찜하기
        try{
            const result = await $.ajax("/api/v1/favorite/check?productNo="+productNo);
            if(result == true){
                $('#favorite_text').text("찜하기 취소");
            }else{
                $('#favorite_text').text("찜하기");
            }
        }catch (err){
            console.log(err)
        }
        $('#favorite').on('click',async function(){
            try{
                const result = await $.ajax({url:'/api/v1/favorite/add?productNo='+productNo, method:"patch"});
                if(result.favorite == true){
                    $('#favorite_text').text("찜하기 취소");
                } else {
                    $('#favorite_text').text("찜하기")
                }
            }catch (err){
                console.log(err)
            }
        })


        // qna 문의하기
        $("#write").click(function() {
            const $productNo = $("#productNo").text();
            window.location.href = "http://localhost:8081/mall/product/qna/write?productNo=" + $productNo;
        });



        // 장바구니 담기
        $('#cart').click(async function() {
            console.log("/api/v1/cart/add?productNo=" + $("#productNo").text());
            try {
                const result = await $.ajax({url: "/api/v1/cart/add?productNo=" + $("#productNo").text(), method:"post"});
                const choice = await Swal.fire({
                    title: result,
                    text: "장바구니로 이동하시겠습니까?",
                    showCancelButton: true,
                    confirmButtonText: '장바구니로 이동',
                    cancelButtonText: '쇼핑 계속하기',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                });
                if(choice.isConfirmed==true)
                    location.href = "/mall/cart/list";
            } catch(err) {
                if(err.status==409)
                    alert(err.responseText);
            }
        });


        // 주문하기
        $('#buy').click(async function() {
            const checkedProductNos = [];
            const productNo = $('#productNo').text();
            checkedProductNos.push(productNo);
            const $form = $('<form>').attr("id", "checkedProductNosForm").attr("action","/mall/order").attr("method","post").appendTo($('body'));
            $form.append($('<input>').attr('type','hidden').attr('name','checkedProductNos').val(checkedProductNos));
            $form.submit();
        });


        // 품절시 버튼 변경
        const stock = document.getElementById('productStock').value;
        const buyButton = document.getElementById('buy');

        if (stock == 0) {
            buyButton.disabled = true;
            buyButton.innerText = '품절';
        } else {
            buyButton.disabled = false;
            buyButton.innerText = '구매하기';
        }
    });
</script>
</head>
<body>
<div id="page">
    <header th:replace="~{/fragment/header.html}"></header>
    <nav th:replace="~{/fragment/nav.html}"></nav>
    <main>
        <aside th:replace="~{/fragment/aside.html}">
        </aside>
        <section>
            <div style="display:none;" th:text="${product.productNo}" id="productNo"></div>
            <div style="overflow:hidden;">
                <div id="left">
                    <div>
                        <img th:src="${product.productImages[0]}" id="select_image" height="300px" width="325px">
                    </div>
                    <div>
                        <img th:each="image:${product.productImages}" th:src="${image}" height="100px" width="100px" style="margin: 5px;" class='images'>
                    </div>
                </div>
                <div id="right">
                    <div th:text="${product.productName}"></div>
                    <div>별점출력하는곳</div>
                    <!--<div th:text="${product.productGrade}"></div>-->
                    <span class="product-price">
                          <div id="product-stock" th:if="${product.productStock == 0}">
                            <span style="color: red">품절댐</span>
                          </div>
                          <div th:unless="${product.productStock == 0}">
                            <div>
                              <span th:text="${#numbers.formatInteger(product.productPrice,0,'COMMA')}+'원'"></span>
                            </div>
                          </div>
                        </span>
                    <div>뼈다귀 포인트 1% 적립</div>
                    <div>배송정보 배송비 3,000원</div>
                </div>
                <div id="buttons">
                    <input type="hidden" id="productStock" name="productStock" th:value="${product.productStock}" />
                    <button class="btn btn-secondary" id="buy" th:disabled="${product.productStock == 0}">구매하기</button>
                    <button class="btn btn-secondary" id="cart" th:disabled="${product.productStock == 0}">장바구니</button>
                    <button class="btn btn-secondary" id="favorite"><span id="favorite_text">찜하기</span></button>
                </div>
            </div>
            <div id="formArea">
            </div>
            <div id="content" th:utext="${product.productContent}"></div>


            <hr>
            <h3>리뷰 출력중</h3>
            <div>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>별점</th><th>내용</th><th>작성자</th><th>작성일</th>
                        </tr>
                    </thead>
                    <tbody id="review">
                    </tbody>
                </table>
                <ul class="pagination" id="page_ul">
                </ul>
            </div>


            <hr>
            <h3>qna 출력중 (관리자답변도 같이 끌고오세요)</h3>
            <div>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>내용</th><th>작성자</th><th>작성일</th>
                        </tr>
                    </thead>
                    <tbody id="qna">
                    </tbody>
                </table>
                <button id="write" class="btn btn-primary">문의하기</button>
                <ul class="pagination" id="q_page_ul">
                </ul>
            </div>
        </section>
        <aside th:replace="~{/fragment/bside.html}"></aside>
    </main>
    <footer th:replace="~{/fragment/footer.html}">
    </footer>
</div>
</body>
</html>