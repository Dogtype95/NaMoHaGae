<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>퍼칭 메인화면</title>
    <link rel="stylesheet" href="/main.css">
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=660792846d96851836832221cf48b4f7"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.js"
            integrity="sha256-a9jBBRygX1Bh5lt8GZjXDzyOB+bWve9EiO7tROUtj/E=" crossorigin="anonymous"></script>
    <style>
        #list {
            height: 400px;
            width:500px;
            overflow-y: scroll;
            border: 1px solid black;
            padding: 10px;
        }
        .item {
            margin-bottom: 10px;
            border: 1px solid gray;
            padding: 10px;
        }
    </style>
</head>
<body>
<div id="page">
    <header id="header" th:replace="~{/fragment/header.html}">
    </header>
    <nav id="nav" th:replace="~{/fragment/nav.html}">
    </nav>
    <main>
        <aside id="aside" th:replace="~{/fragment/aside.html}">
        </aside>
        <section id="section">
            <div id="map" style="width:500px;height:400px; float:left;"></div>
            <button onclick="getCurrentPosBtn()">내위치 받아오기</button>
            <div id="list"></div>
            <script>
                function roundLatlong(num,n){
                    return +(Math.round(num + "e+" + n)  + "e-" + n);
                }
                function locationLoadSuccess(pos){
                    // geo로 받은 내위치
                    var currentPos = new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude);

                    map.panTo(currentPos);

                    var marker = new kakao.maps.Marker({
                       position: currentPos
                    });
                    marker.setMap(null);
                    marker.setMap(map)
                    map.setCenter(currentPos);
                }
                function locationLoadError(pos){
                    alert('위치 정보를 못가져왔넹')
                }
                function getCurrentPosBtn(){
                    navigator.geolocation.getCurrentPosition(locationLoadSuccess,locationLoadError);
                }
            </script>
            <script>
                // 초기 아이템 로드
                var itemList = document.getElementById("list");
                var items = [];
                for (var i = 0; i < 10; i++) {
                    items.push("Item " + (i + 1));
                    itemList.innerHTML += "<div class='item'>Item " + (i + 1) + "</div>";
                }

                // 스크롤 이벤트 핸들러 등록
                var lastScrollTop = 0;
                itemList.addEventListener("scroll", function() {
                    var st = this.scrollTop;
                    if (st > lastScrollTop) {
                        // 아래로 스크롤됨
                        if (itemList.scrollTop + itemList.clientHeight >= itemList.scrollHeight) {
                            // 리스트의 끝까지 도달함
                            for (var i = 0; i < 10; i++) {
                                items.push("Item " + (items.length + 1));
                                itemList.innerHTML += "<div class='item'>Item " + (items.length) + "</div>";
                            }
                        }
                    }
                    lastScrollTop = st;
                });
            </script>
            <script>
                var mapContainer = document.getElementById('map'), // 지도를 표시할 div
                    mapOption = {
                        center: new kakao.maps.LatLng(37.4398411, 126.6640894), // 지도의 중심좌표 geo로 값을 변경해주자
                        level: 3 // 지도의 확대 레벨
                    };
                // 지도를 생성한다
                var map = new kakao.maps.Map(mapContainer, mapOption);
                map.setMinLevel(3);
                map.setMaxLevel(6);
            </script>
            <script>
                // 다각형에 마우스오버 이벤트가 발생했을 때 변경할 채우기 옵션입니다
                var mouseoverOption = {
                    fillColor: '#02eccd', // 채우기 색깔입니다
                    fillOpacity: 0.4 // 채우기 불투명도 입니다
                };
                // 다각형에 마우스아웃 이벤트가 발생했을 때 변경할 채우기 옵션입니다
                var mouseoutOption = {
                    fillColor: '#02eccd', // 채우기 색깔입니다
                    fillOpacity: 0.7 // 채우기 불투명도 입니다
                };
                var gettowndata= $.get("/api/v1/puching/townlist",function (data) {
                    var circles = data.map(function (i, position) {
                        var circle = new kakao.maps.Circle({
                            map: map, // 원을 표시할 지도 객체
                            center: new kakao.maps.LatLng(i.townLatitude, i.townLongitude), // 지도의 중심 좌표
                            radius: 100, // 원의 반지름 (단위 : m)
                            fillColor: '#02eccd', // 채움 색
                            fillOpacity: 0.7, // 채움 불투명도
                            strokeWeight: 3, // 선의 두께
                            strokeColor: '#a6e3e3', // 선 색
                            strokeOpacity: 0.9, // 선 투명도
                            strokeStyle: 'solid' // 선 스타일
                        });
                        var infowindow = new kakao.maps.InfoWindow({
                            map: map,
                            position: new kakao.maps.LatLng(i.townLatitude, i.townLongitude),
                            content: i.townDong+' '+i.townCnt+'명'
                        });


                        // 원클릭시 리스트 초기화 및 조건에 맞는 리스트 출력
                        kakao.maps.event.addListener(circle, 'click', function () {
                            var circlecenter= circle.getPosition();
                            var La=roundLatlong(circlecenter.La,7);
                            var Ma=roundLatlong(circlecenter.Ma,7);
                            console.log('원을 클릭했습니다');
                            console.log(Ma,La);
                            map.setCenter(new kakao.maps.LatLng(Ma,La));
                        });

                        // 마커에 mouseover 이벤트를 등록한다
                        kakao.maps.event.addListener(circle, 'mouseover', function () {
                         circle.setOptions(mouseoverOption);
                            console.log('원에 mouseover 이벤트가 발생했습니다!');
                        });

                        // 마커에 mouseout 이벤트 등록
                        kakao.maps.event.addListener(circle, 'mouseout', function () {
                            circle.setOptions(mouseoutOption);
                            console.log('원에 mouseout 이벤트가 발생했습니다!');
                        });
                        return circle;
                    })


                    // 지도 확대 레벨 변화 이벤트를 등록한다
                    kakao.maps.event.addListener(map, 'zoom_changed', function () {
                        console.log('지도의 현재 확대레벨은 ' + map.getLevel() + '레벨 입니다.');
                    });
                    // 드러그 앤드 이벤트 발생시 리스트 초기화하고 중앙 좌표에서 가까운 사람을 리스트로 출력
                    kakao.maps.event.addListener(map, 'dragend', function() {
                        console.log('지도의 중심 좌표는 ' + map.getCenter().toString() + ' 입니다.');
                    });



                })


            </script>
        </section>
    </main>
    <footer id="footer" th:replace="~{/fragment/footer.html}">
    </footer>
</div>


</body>
</html>
