<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <link rel="stylesheet" href="/main.css">
    <style >
        .hidden{ display: none;}
    </style>
    <script th:inline="javascript">
        const msg = [[${msg}]];
        if(msg!=null)
            alert(msg);
    </script>
    <script>
        function sample4_execDaumPostcode() {
            new daum.Postcode({
                oncomplete : function(data) {
                    var roadAddr = data.roadAddress;
                    var extraRoadAddr = '';

                    if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                        extraRoadAddr += data.bname;
                    }
                    if (data.buildingName !== '' && data.apartment === 'Y') {
                        extraRoadAddr += (extraRoadAddr !== '' ? ', '	+ data.buildingName : data.buildingName);
                    }
                    if (extraRoadAddr !== '') {
                        extraRoadAddr = ' (' + extraRoadAddr + ')';
                    }

                    document.getElementById('sample4_postcode').value = data.zonecode;
                    document.getElementById("sample4_roadAddress").value = roadAddr;
                    document.getElementById("sample4_jibunAddress").value = data.jibunAddress;

                    if (roadAddr !== '') {
                        document.getElementById("sample4_extraAddress").value = extraRoadAddr;
                    } else {
                        document.getElementById("sample4_extraAddress").value = '';
                    }

                    var guideTextBox = document.getElementById("guide");
                    if (data.autoRoadAddress) {
                        var expRoadAddr = data.autoRoadAddress + extraRoadAddr;
                        guideTextBox.innerHTML = '(예상 도로명 주소 : ' + expRoadAddr + ')';
                        guideTextBox.style.display = 'block';
                    } else if (data.autoJibunAddress) {
                        var expJibunAddr = data.autoJibunAddress;
                        guideTextBox.innerHTML = '(예상 지번 주소 : '		+ expJibunAddr + ')';
                        guideTextBox.style.display = 'block';
                    } else {
                        guideTextBox.innerHTML = '';
                        guideTextBox.style.display = 'none';
                    }
                }
            }).open();

        }

        const apiUrl = 'https://dapi.kakao.com/v2/local/search/address.json';
        const headers = { 'Authorization': 'KakaoAK 3aebe1c5743b1fcc93a6bfb52e8ff445' };
        const address = document.getElementById("sample4_roadAddress").value;

    </script>
    <script>
        $(document).ready(function(){
            $('#sendEmail').click(async function (){
                try {
                    const url = "/member/sendAudenticationCode?email=" + $("#memberEmail").val();
                    // await를 빼먹으면 나중에 결과가 들어갈 것이라는 약속(Promise)로 리턴
                    // Promise에는 done()을 이용해 성공 핸들러를 지정할 수 있다
                    const result = await $.ajax({url:url, method:"patch"});
                    alert(result);
                    $('#checkCodeArea').removeClass('hidden');
                } catch(err) {
                    alert("이메일을 찾지 못했습니다")
                }
            });
            $('#checkCode').click(async function(){
                try {
                const url = "/member/checkAudenticationCode?code=" + $("#code").val();
                // await를 빼먹으면 나중에 결과가 들어갈 것이라는 약속(Promise)로 리턴
                // Promise에는 done()을 이용해 성공 핸들러를 지정할 수 있다
                const result = await $.ajax({url:url, method:"get"});
                alert(result);
                    $('#join').prop('disabled', false);
                }catch (err){
                    alert("인증에 실패했습니다")
                }
            });
            $('#join').click(async function (){
                $.ajax({
                    url:'https://dapi.kakao.com/v2/local/search/address.json?query='+encodeURIComponent(document.getElementById("sample4_roadAddress").value),
                    type:'GET',
                    headers: { 'Authorization': 'KakaoAK 3aebe1c5743b1fcc93a6bfb52e8ff445' },
                    dataType: 'json',
                    success: function(data){
                        const latitude = data.documents[0].road_address.x;
                        const longitude = data.documents[0].road_address.y;
                        const gu = data.documents[0].address.region_2depth_name;
                        const dong = data.documents[0].address.region_3depth_h_name;
                        document.getElementById("memberDong").value = dong;
                        document.getElementById("memberGu").value = gu;
                        document.getElementById("memberLatitude").value = longitude;
                        document.getElementById("memberLongitude").value = latitude;
                        $('#join_form').submit();
                    },error: function(xhr, status, error){
                        console.log(error);
                    }


                })
            })

        })
    </script>


    <title>회원 가입</title>
</head>
<body>
<div id="page">
    <header th:replace="~{/fragment/header.html}"> </header>
    <nav th:replace="~{/fragment/nav.html}"></nav>
    <main>
        <aside th:replace="~{/fragment/aside.html}"></aside>
        <section>
            <h1>회원 가입</h1>
            <form id="join_form" method="post" action="/member/join" enctype="multipart/form-data">
                <div class="mb-3 mt-3">
                    <input type="file" name="memberProfileImage" id="memberProfileImage" class="form-control">
                </div>
                <div class="mb-3 mt-3">
                    <label for="memberEmail">이메일:</label>
                    <div>
                    <input type="text" name="memberEmail" id="memberEmail" class="form-control">
                    <button type="button" id="sendEmail" class="btn btn-primary btn-block">인증요청</button>
                    </div>
                    <div id="checkCodeArea" class="hidden">
                    <input type="text" id="code" name="code" class="form-control">
                    <button type="button" id="checkCode" class="btn btn-primary btn-block">인증확인</button>
                    </div>
                    <span id="memberEmail_msg"></span>
                </div>
                <div class="mb-3 mt-3">
                    <label for="memberPassword">비밀번호:</label>
                    <input type="password" name="memberPassword" id="memberPassword" class="form-control">
                    <span id="memberPassword_msg"></span>
                </div>

                <div class="mb-3 mt-3">
                    <label for="memberNickname">별명:</label>
                    <input type="text" name="memberNickname" id="memberNickname" class="form-control" maxlength="10">
                    <span id="memberNickname_msg"></span>
                </div>
                <div class="mb-3 mt-3">
                    <label for="memberPhone">연락처:</label>
                    <input type="text" name="memberPhone" id="memberPhone" class="form-control" maxlength="13">
                    <span id="memberPhone_msg"></span>
                </div>
                <div class="mb-3 mt-3">
                    <label for="memberIntroduce">자기 소개:</label>
                    <input type="text" name="memberIntroduce" id="memberIntroduce" class="form-control">
                    <span id="memberIntroduce_msg"></span>
                </div>
                <div class="mb-3 mt-3">
                        <div class="mb-3 mt-3">
                            <input type="text" class="form-control" id="sample4_postcode" placeholder="우편번호" name="zipcode">
                            <input type="button" class="btn btn-outline-primary" onclick="sample4_execDaumPostcode()" value="우편번호 찾기">
                        </div>
                        <div class="mb-3 mt-3">
                            <input type="text" class="form-control" id="sample4_roadAddress" placeholder="도로명주소" name="address1">
                        </div>
                        <input type="text" id="sample4_jibunAddress" placeholder="지번주소" style="display:none;">
                        <span id="guide" style="color: #999; display: none"></span>
                        <div class="mb-3 mt-3">
                            <input type="text" class="form-control" id="sample4_detailAddress" placeholder="상세주소" name="address2">
                        </div>
                        <input type="text" id="sample4_extraAddress" placeholder="참고항목" style="display:none;">
                </div>
                    <input type="hidden" id="memberLatitude" name="memberLatitude">
                    <input type="hidden" id="memberLongitude" name="memberLongitude">
                    <input type="hidden" id="memberDong" name="townDong">
                    <input type="hidden" id="memberGu" name="townGu">
                <div class="mb-3 mt-3 d-grid">
                    <button id="join" type="button" disabled="disabled" class="btn btn-primary btn-block">가입</button>
                </div>
            </form>
        </section>
    </main>
    <footer th:replace="~{/fragment/footer.html}"> </footer>
</div>
</body>
</html>
