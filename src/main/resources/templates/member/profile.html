<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!------------------------------------------------------------------------------------------------------------------------------>
  <!--스크립트 태그-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>                    <!--jQuery-->
  <script src="https://kit.fontawesome.com/a606a1a405.js" crossorigin="anonymous"></script>                   <!--FontAwesome-->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>        <!--BootStrap-->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js"></script>         <!--SweetAlert2-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>               <!--Toastr-->
  <!--CSS 링크-->
  <link rel="stylesheet" href="/css/main.css">                                                                <!--MainCSS-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">    <!--FontAwesome-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">      <!--BootStrap-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css">     <!--SweetAlert2-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">       <!--Toastr-->
  <!--기타 삽입-->

  <!------------------------------------------------------------------------------------------------------------------------------>
  <script src="/script/profile.js"></script>
  <title>내 정보</title>
  <script>
    function printBoard(review) {
      $('#review').empty();
      const $tbody = $('#review');
      for(const r of review) {
        const tpl = `<tr>
				<td>${r.reviewReceiver}</td>
				<td>${r.reviewContent}</td>
			</tr>`;
        $tbody.append(tpl);
      }
    }
    function printPagination({prev, start, end, next, pageno}) {
      $('#page_ul').empty();
      const $ul = $('#page_ul');
      if(prev>0)
        $ul.append(`<li class='page-item'><a class='page-link' href='#' data-page-no='${prev}'>이전</a></li>`);
      for(let i=start; i<=end; i++) {
        const tpl = `
			<li class='page-item ${pageno==i? "active":""}'>
				<a class='page-link' href='#' data-page-no='${i}'>${i}</a>
			</li>
		`;
        $ul.append(tpl);
      }
      if(next>0)
        $ul.append(`<li class='page-item'><a class='page-link' href='#' data-page-no='${next}'>다음</a></li>`)
    }

    $(document).ready(async function() {
    let result = undefined;
      const param = new URLSearchParams(location.search);
      const memberNo = param.get('memberNo');
      const pageno = param.get('pageno') == null ? 1 : param.get('pageno');
      try {
        result = await $.ajax("/api/v1/review/list?pageno=" + pageno+"&memberNo="+memberNo);
        console.log(result);
        printBoard(result.review);
        printPagination(result);

        // Add a click event listener to the pagination links
        $('#page_ul').on('click', '.page-link', async function (e) {
          $('#review').remove();
          e.preventDefault();
          const pageNum = $(this).data('page-no');
          const result = await $.ajax("/api/v1/review/list?pageno=" + pageNum);
          console.log(result);
          printBoard(result.review);
          printPagination(result);
        });
      }catch (err){
        console.log(err);
      }
      try{
        const result = await $.ajax("/api/v1/follow/check?memberNo="+memberNo);
        if(result == true){
        $('#follow_text').text("팔로우취소 ");
        }else{
          $('#follow_text').text("팔로우 ");
        }
      }catch (err){
        console.log(err)
      }
      $('#follow_btn').on('click',async function(){
        try{
          // 추천하면 서버는 새로운 추천수를 리턴한다 -> #good_cnt를 업데이트
          const result =await $.ajax({url:'/api/v1/member/follow?memberNo='+memberNo, method:"patch",});
          if(result.follow == true){
          $('#follow_text').text("팔로우취소 ");
          } else {
          $('#follow_text').text("팔로우")
          }
        }catch (err){
          console.log(err)
          }
      })
    });
  </script>
</head>
<body>
<div id="page">
  <header th:replace="~{/fragment/header.html}"></header>
  <nav th:replace="~{/fragment/nav.html}"></nav>
  <main>
    <aside th:replace="~{/fragment/aside.html}"></aside>
    <section>
      <table class ="table table-hover">
        <colgroup>
          <col width="30%">
          <col width="70%">
        </colgroup>
        <tr>
          <td colspan="2">
            <img id="show-profile" th:src="${member.memberProfile}" width="240px">
          </td>
        </tr>
        <tr>
          <td>
            <span th:text="${member.memberNickname}"></span><span>님의 정보   (</span><span th:text="${member.memberGrade}"></span><span>)도</span></td>
        </tr>
        <tr>
          <td>강아지</td>
          <td id="dog"></td>
        </tr>
          <td>자기소개</td>
          <td>
            <label for="introduce">
              <textarea th:text="${member.memberIntroduce}" id="introduce" name="introduce" readonly></textarea>
            </label>
          </td>
        </tr>
        <tr id="review">
          <td>
            <ul class="pagination" id="page_ul">
            </ul>
          </td>

        </tr>
      </table>
      <button type="button" class="btn btn-primary" id="follow_btn" > <span id="follow_text">팔로우</span></button>
      <button id="chat" type="button" class="btn btn-danger"><a th:href="@{/puching/chatroom(receiverEmail=${member.memberEmail})}">채팅하기</a></button>
      <button id="report" type="button" class="btn btn-primary"><a th:href="@{/member/report(memberNo=${member.memberNo})}" target="_blank" style="color: white;">신고하기</a></button>
    </section>
    <aside th:replace="~{/fragment/bside.html}"></aside>
  </main>
  <footer th:replace="~{/fragment/footer.html}">
  </footer>
</div>
</body>
</html>