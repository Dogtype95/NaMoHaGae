<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.kro.namohagae.mall.dao.QnaDao">
    <!-- 큐엔에이 저장 -->
    <insert id="save">
        <selectKey keyProperty="qnaNo" order="BEFORE" resultType="int">
            select qna_seq_qna_no.nextval from dual
        </selectKey>
        insert into QNA (qna_no, product_no, qna_writer, qna_content, qna_write_date)
        values (#{qnaNo}, #{productNo}, #{qnaWriter}, #{qnaContent}, #{qnaWriteDate})
    </insert>


    <!-- 특정 상품의 큐엔에이 개수를 조회 -->
    <select id="count" resultType="java.lang.Integer" parameterType="java.lang.Integer">
        select count(*) from QNA where product_no = #{productNo}
    </select>

    <!-- 상품 큐엔에이 보기 -->
    <select id="findByProductNo" resultType="Qna">
        select * from QNA where product_no=#{productNo}
    </select>

    <select id="findByQnaNo" resultType="kr.kro.namohagae.mall.dto.QnaDto$Read">
        select
            QNA_NO,
            p.PRODUCT_NAME,
            qna_writer,
            MEMBER_NICKNAME,
            QNA_CONTENT, QNA_WRITE_DATE
        from QNA
                 join PRODUCT P on P.PRODUCT_NO = QNA.PRODUCT_NO
                 join member m on qna.QNA_WRITER = m.MEMBER_NO
        where QNA_NO = #{qnaNo} and QNA_ANSWER_CONTENT is null
        order by QNA_WRITE_DATE
    </select>

    <!-- 특정 상품의 큐엔에이 목록 조회 -->
    <select id="findAllByProductNo" resultType="Qna">
        select * from
            (
                select rownum as rnum, q.* from
                    (
                        select * from QNA where product_no=#{productNo} order by qna_no desc
                    ) q
                where rownum&lt;=#{endRowNum}
            )
        where rnum&gt;=#{startRowNum}
    </select>

    <select id="findAll" resultType="kr.kro.namohagae.mall.dto.QnaDto$Read">
        select
            QNA_NO,
            p.PRODUCT_NAME,
            qna_writer,
            MEMBER_NICKNAME,
           QNA_CONTENT, QNA_WRITE_DATE
        from QNA
            join PRODUCT P on P.PRODUCT_NO = QNA.PRODUCT_NO
            join member m on qna.QNA_WRITER = m.MEMBER_NO
        where QNA_ANSWER_CONTENT is null
        order by QNA_WRITE_DATE
    </select>

    <update id="update" parameterType="Qna">
        update QNA SET
        QNA_ANSWER_CONTENT = #{qnaAnswerContent},
        QNA_ANSWER_WRITE_DATE = #{qnaAnswerWriteDate}
        where QNA_NO = #{qnaNo}
    </update>
</mapper>